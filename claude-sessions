#!/usr/bin/env python3
"""
Claude Sessions Manager - List Sessions
Mostra histÃ³rico de conversas do Claude CLI
"""

import json
import sys
from datetime import datetime
from pathlib import Path
from collections import OrderedDict

HISTORY_FILE = Path.home() / ".claude" / "history.jsonl"

def list_sessions():
    if not HISTORY_FILE.exists():
        print(f"âŒ Arquivo de histÃ³rico nÃ£o encontrado: {HISTORY_FILE}")
        print("ğŸ’¡ Certifique-se de que o Claude Code estÃ¡ instalado e vocÃª jÃ¡ teve algumas conversas.")
        sys.exit(1)

    print("ğŸ“š HistÃ³rico de SessÃµes do Claude CLI")
    print("â•" * 60)
    print()

    # Ler todas as sessÃµes
    sessions = OrderedDict()

    with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
        for line in f:
            try:
                entry = json.loads(line)
                session_id = entry.get('sessionId')

                if not session_id or session_id == 'null':
                    continue

                if session_id not in sessions:
                    timestamp = entry.get('timestamp', 0)
                    display = entry.get('display', '')[:60]
                    project = entry.get('project', 'Unknown')
                    project_name = Path(project).name if project else 'Unknown'

                    date_str = datetime.fromtimestamp(timestamp / 1000).strftime('%d/%m/%Y %H:%M')

                    sessions[session_id] = {
                        'date': date_str,
                        'preview': display,
                        'project': project_name,
                        'timestamp': timestamp
                    }
            except json.JSONDecodeError:
                continue

    # Mostrar Ãºltimas 20 sessÃµes
    sorted_sessions = sorted(sessions.items(), key=lambda x: x[1]['timestamp'], reverse=True)

    if not sorted_sessions:
        print("âŒ Nenhuma sessÃ£o encontrada ainda.")
        print("ğŸ’¡ Use o Claude Code para comeÃ§ar a salvar conversas automaticamente.")
        sys.exit(0)

    for session_id, data in sorted_sessions[:20]:
        print(f"ğŸ“„ SessÃ£o: {session_id[:8]}... ({data['date']})")
        print(f"   Projeto: {data['project']}")
        print(f"   Preview: {data['preview']}...")
        print()

    print("â•" * 60)
    print()
    print("ğŸ’¡ Para ver uma sessÃ£o completa:")
    print("   claude-view <sessionId>")
    print()
    print("ğŸ’¡ Para buscar por palavra-chave:")
    print("   claude-search <palavra>")
    print()
    print("ğŸ’¡ SessÃ£o atual:")

    with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
        lines = f.readlines()
        for line in reversed(lines):
            try:
                entry = json.loads(line)
                if entry.get('sessionId'):
                    print(f"   {entry['sessionId']}")
                    break
            except:
                continue

if __name__ == '__main__':
    list_sessions()
