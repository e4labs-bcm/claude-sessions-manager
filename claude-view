#!/usr/bin/env python3
"""
Claude Sessions Manager - View Session
Mostra conversa completa de uma sess√£o (aceita ID curto ou completo)
"""

import json
import sys
from datetime import datetime
from pathlib import Path

def view_session():
    if len(sys.argv) < 2:
        print("‚ùå Uso: claude-view <sessionId>")
        print()
        print("üí° Para listar sess√µes dispon√≠veis:")
        print("   claude-sessions")
        sys.exit(1)

    SESSION_ID_PREFIX = sys.argv[1]
    HISTORY_FILE = Path.home() / ".claude" / "history.jsonl"

    if not HISTORY_FILE.exists():
        print(f"‚ùå Arquivo de hist√≥rico n√£o encontrado: {HISTORY_FILE}")
        sys.exit(1)

    # Encontrar sessionId completo (aceita ID curto ou completo)
    full_session_id = None
    with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
        for line in f:
            try:
                entry = json.loads(line)
                sid = entry.get('sessionId')
                if sid and (sid == SESSION_ID_PREFIX or sid.startswith(SESSION_ID_PREFIX)):
                    full_session_id = sid
                    break
            except json.JSONDecodeError:
                continue

    if not full_session_id:
        print(f"‚ùå Sess√£o n√£o encontrada: {SESSION_ID_PREFIX}")
        print("üí° Use: claude-sessions para ver sess√µes dispon√≠veis")
        sys.exit(1)

    print(f"üìñ Sess√£o: {full_session_id}")
    print("‚ïê" * 60)
    print()

    messages = []

    with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
        for line in f:
            try:
                entry = json.loads(line)
                if entry.get('sessionId') == full_session_id:
                    timestamp = entry.get('timestamp', 0)
                    display = entry.get('display', '')
                    time_str = datetime.fromtimestamp(timestamp / 1000).strftime('%H:%M:%S')
                    messages.append((time_str, display))
            except json.JSONDecodeError:
                continue

    if not messages:
        print(f"‚ùå Nenhuma mensagem encontrada para sess√£o: {SESSION_ID_PREFIX}")
        sys.exit(1)

    for time_str, display in messages:
        print(f"[{time_str}] {display}")
        print()

    print("‚ïê" * 60)
    print()
    print("üí° Para copiar e colar em nova conversa, redirecione para arquivo:")
    print(f"   claude-view {full_session_id} > /tmp/session.txt")

if __name__ == '__main__':
    view_session()
