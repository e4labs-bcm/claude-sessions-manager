#!/usr/bin/env python3
"""
Claude History - Comando Unificado com Linguagem Natural
Interpreta comandos em portuguÃªs e executa a aÃ§Ã£o apropriada
"""

import sys
import subprocess
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent.absolute()

def show_help():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                    â•‘
â•‘                    ğŸ“š CLAUDE HISTORY v1.0.0                        â•‘
â•‘                                                                    â•‘
â•‘              Comando unificado com linguagem natural               â•‘
â•‘                                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ USO SIMPLES - Fale naturalmente!

  claude-history "Ãºltima sessÃ£o"
  claude-history "buscar git"
  claude-history "listar"
  claude-history "ver 065fa436"
  claude-history "procurar autenticaÃ§Ã£o"

ğŸ“– COMANDOS ACEITOS:

  Listar SessÃµes:
    â€¢ "listar", "lista", "sessÃµes", "conversas", "Ãºltimas"
    â€¢ "show sessions", "list"

  Ver SessÃ£o:
    â€¢ "ver <id>", "mostrar <id>", "view <id>"
    â€¢ "sessÃ£o <id>", "conversa <id>"
    â€¢ Aceita ID curto (8 caracteres)

  Buscar:
    â€¢ "buscar <termo>", "procurar <termo>", "search <termo>"
    â€¢ "encontrar <termo>", "achar <termo>"

  Ãšltima SessÃ£o:
    â€¢ "Ãºltima", "Ãºltima sessÃ£o", "last session"
    â€¢ "recente", "anterior"

ğŸ’¡ EXEMPLOS:

  # Listar
  claude-history "listar"
  claude-history "Ãºltimas sessÃµes"

  # Ver especÃ­fica
  claude-history "ver 065fa436"
  claude-history "mostrar sessÃ£o 46f5b309"

  # Buscar
  claude-history "buscar git"
  claude-history "procurar autenticaÃ§Ã£o"

  # Ãšltima
  claude-history "Ãºltima sessÃ£o"
  claude-history "o que estÃ¡vamos fazendo?"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ Dica: NÃ£o precisa decorar comandos! Fale naturalmente.
""")

def run_command(cmd):
    """Executa um dos comandos do claude-sessions-manager"""
    try:
        result = subprocess.run(
            cmd,
            shell=True,
            capture_output=True,
            text=True
        )
        print(result.stdout)
        if result.stderr:
            print(result.stderr, file=sys.stderr)
        return result.returncode
    except Exception as e:
        print(f"âŒ Erro ao executar comando: {e}", file=sys.stderr)
        return 1

def parse_and_execute(query):
    """Interpreta o comando em linguagem natural"""
    query_lower = query.lower()

    # Detectar sessÃ£o ID (8+ caracteres alfanumÃ©ricos)
    import re
    session_id_match = re.search(r'\b([a-f0-9]{8})\b', query_lower)

    # PadrÃµes para listar
    list_patterns = [
        'listar', 'lista', 'sessÃµes', 'sessoes', 'conversas',
        'Ãºltimas', 'ultimas', 'list', 'show', 'todas'
    ]

    # PadrÃµes para ver sessÃ£o
    view_patterns = [
        'ver', 'mostrar', 'view', 'show', 'sessÃ£o', 'sessao',
        'conversa', 'abrir', 'detalhes'
    ]

    # PadrÃµes para buscar
    search_patterns = [
        'buscar', 'procurar', 'search', 'encontrar', 'achar',
        'pesquisar', 'grep', 'find'
    ]

    # PadrÃµes para Ãºltima sessÃ£o
    last_patterns = [
        'Ãºltima', 'ultima', 'last', 'recente', 'anterior',
        'latest', 'most recent'
    ]

    # DecisÃ£o: Ãšltima sessÃ£o
    if any(pattern in query_lower for pattern in last_patterns):
        print("ğŸ” Buscando Ãºltima sessÃ£o...")
        print()
        return run_command(f"{SCRIPT_DIR}/claude-sessions | head -8")

    # DecisÃ£o: Ver sessÃ£o especÃ­fica
    if session_id_match or any(pattern in query_lower for pattern in view_patterns):
        if session_id_match:
            session_id = session_id_match.group(1)
            print(f"ğŸ“– Carregando sessÃ£o {session_id}...")
            print()
            return run_command(f"{SCRIPT_DIR}/claude-view {session_id}")
        else:
            print("âŒ ID da sessÃ£o nÃ£o encontrado.")
            print("ğŸ’¡ Use: claude-history 'ver <id>'")
            print("ğŸ’¡ Ou liste as sessÃµes: claude-history 'listar'")
            return 1

    # DecisÃ£o: Listar sessÃµes
    if any(pattern in query_lower for pattern in list_patterns):
        print("ğŸ“š Listando sessÃµes...")
        print()
        return run_command(f"{SCRIPT_DIR}/claude-sessions")

    # DecisÃ£o: Buscar
    if any(pattern in query_lower for pattern in search_patterns):
        # Extrair termo de busca
        for pattern in search_patterns:
            if pattern in query_lower:
                # Pegar o que vem depois do padrÃ£o
                parts = query_lower.split(pattern, 1)
                if len(parts) > 1:
                    search_term = parts[1].strip().strip('"\'')
                    if search_term:
                        print(f"ğŸ” Buscando por: \"{search_term}\"")
                        print()
                        return run_command(f"{SCRIPT_DIR}/claude-search \"{search_term}\"")

        print("âŒ Termo de busca nÃ£o especificado.")
        print("ğŸ’¡ Use: claude-history 'buscar <termo>'")
        return 1

    # Fallback: tentar interpretar como busca
    if len(query) > 0 and not query.startswith('-'):
        print(f"ğŸ” Buscando por: \"{query}\"")
        print()
        return run_command(f"{SCRIPT_DIR}/claude-search \"{query}\"")

    # NÃ£o entendeu
    print("â“ NÃ£o entendi o comando.")
    print()
    print("ğŸ’¡ Exemplos:")
    print("   claude-history 'listar'")
    print("   claude-history 'buscar git'")
    print("   claude-history 'ver 065fa436'")
    print("   claude-history 'Ãºltima sessÃ£o'")
    print()
    print("Use: claude-history --help para mais informaÃ§Ãµes")
    return 1

def main():
    if len(sys.argv) < 2 or sys.argv[1] in ['-h', '--help', 'help']:
        show_help()
        return 0

    # Juntar todos os argumentos como uma query
    query = ' '.join(sys.argv[1:])

    return parse_and_execute(query)

if __name__ == '__main__':
    sys.exit(main())
